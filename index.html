import React, { useState, useRef, useEffect, useCallback } from 'react';
import { Settings, Play, Trash2, Plus, Zap, MousePointer2, Move, Share2, Download } from 'lucide-react';

/**
 * Logic Gate Configurations and Shapes
 */
const GATE_TYPES = {
  AND: { inputs: 2, color: '#3b82f6', label: 'AND' },
  OR: { inputs: 2, color: '#10b981', label: 'OR' },
  NOT: { inputs: 1, color: '#ef4444', label: 'NOT' },
  XOR: { inputs: 2, color: '#8b5cf6', label: 'XOR' },
  NAND: { inputs: 2, color: '#f59e0b', label: 'NAND' },
  SWITCH: { inputs: 0, color: '#64748b', label: 'IN' },
  BULB: { inputs: 1, color: '#eab308', label: 'OUT' }
};

const App = () => {
  const [nodes, setNodes] = useState([]);
  const [connections, setConnections] = useState([]);
  const [draggingNode, setDraggingNode] = useState(null);
  const [activeWire, setActiveWire] = useState(null);
  const [offset, setOffset] = useState({ x: 0, y: 0 });
  const canvasRef = useRef(null);

  // Simulation State
  const [simulationResults, setSimulationResults] = useState({});

  /**
   * Logic Simulation Logic
   */
  const runSimulation = useCallback(() => {
    const results = {};
    const processed = new Set();

    const evaluate = (nodeId) => {
      if (processed.has(nodeId)) return results[nodeId];
      
      const node = nodes.find(n => n.id === nodeId);
      if (!node) return false;

      if (node.type === 'SWITCH') {
        results[nodeId] = !!node.state;
      } else {
        const incoming = connections
          .filter(conn => conn.toId === nodeId)
          .map(conn => evaluate(conn.fromId));

        let res = false;
        switch (node.type) {
          case 'AND': res = incoming.length >= 2 && incoming.every(v => v); break;
          case 'OR': res = incoming.some(v => v); break;
          case 'NOT': res = incoming.length > 0 ? !incoming[0] : false; break;
          case 'NAND': res = incoming.length >= 2 && !incoming.every(v => v); break;
          case 'XOR': res = incoming.filter(v => v).length % 2 !== 0; break;
          case 'BULB': res = incoming.length > 0 ? incoming[0] : false; break;
          default: res = false;
        }
        results[nodeId] = res;
      }
      
      processed.add(nodeId);
      return results[nodeId];
    };

    nodes.forEach(node => evaluate(node.id));
    setSimulationResults(results);
  }, [nodes, connections]);

  useEffect(() => {
    runSimulation();
  }, [nodes, connections, runSimulation]);

  const addNode = (type) => {
    const newNode = {
      id: `node-${Date.now()}`,
      type,
      x: 100,
      y: 100,
      state: false
    };
    setNodes([...nodes, newNode]);
  };

  const handleMouseDown = (e, node) => {
    if (e.target.dataset.port) return;
    setDraggingNode(node.id);
    const rect = e.currentTarget.getBoundingClientRect();
    setOffset({
      x: e.clientX - rect.left,
      y: e.clientY - rect.top
    });
  };

  const handleMouseMove = (e) => {
    if (draggingNode) {
      const rect = canvasRef.current.getBoundingClientRect();
      setNodes(prev => prev.map(n => 
        n.id === draggingNode 
          ? { ...n, x: e.clientX - rect.left - offset.x, y: e.clientY - rect.top - offset.y } 
          : n
      ));
    }
    if (activeWire) {
      const rect = canvasRef.current.getBoundingClientRect();
      setActiveWire(prev => ({ ...prev, endX: e.clientX - rect.left, endY: e.clientY - rect.top }));
    }
  };

  const handleMouseUp = () => {
    setDraggingNode(null);
    setActiveWire(null);
  };

  const startWire = (e, fromId) => {
    e.stopPropagation();
    const rect = canvasRef.current.getBoundingClientRect();
    setActiveWire({
      fromId,
      startX: e.clientX - rect.left,
      startY: e.clientY - rect.top,
      endX: e.clientX - rect.left,
      endY: e.clientY - rect.top
    });
  };

  const endWire = (e, toId) => {
    e.stopPropagation();
    if (activeWire && activeWire.fromId !== toId) {
      // Check if connection already exists
      const exists = connections.some(c => c.fromId === activeWire.fromId && c.toId === toId);
      if (!exists) {
        setConnections([...connections, { 
          id: `conn-${Date.now()}`, 
          fromId: activeWire.fromId, 
          toId: toId 
        }]);
      }
    }
    setActiveWire(null);
  };

  const toggleSwitch = (id) => {
    setNodes(nodes.map(n => n.id === id ? { ...n, state: !n.state } : n));
  };

  const deleteNode = (id) => {
    setNodes(nodes.filter(n => n.id !== id));
    setConnections(connections.filter(c => c.fromId !== id && c.toId !== id));
  };

  return (
    <div className="flex flex-col h-screen bg-slate-50 overflow-hidden font-sans">
      {/* Header */}
      <header className="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 shrink-0 z-10 shadow-sm">
        <div className="flex items-center gap-2">
          <div className="w-10 h-10 bg-indigo-600 rounded-lg flex items-center justify-center text-white shadow-lg">
            <Zap size={24} fill="currentColor" />
          </div>
          <div>
            <h1 className="text-xl font-bold text-slate-800 leading-none">LogicDraw Pro</h1>
            <p className="text-xs text-slate-500 mt-1 font-medium">Digital Logic Simulator</p>
          </div>
        </div>
        <div className="flex gap-3">
          <button className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition shadow-sm font-medium">
            <Download size={18} /> Export
          </button>
          <button className="p-2 text-slate-600 hover:bg-slate-100 rounded-full transition">
            <Settings size={20} />
          </button>
        </div>
      </header>

      <div className="flex flex-1 overflow-hidden">
        {/* Sidebar Tools */}
        <aside className="w-72 bg-white border-r border-slate-200 p-6 flex flex-col gap-6 shadow-sm z-10 overflow-y-auto">
          <section>
            <h3 className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-4">Components</h3>
            <div className="grid grid-cols-2 gap-3">
              {Object.entries(GATE_TYPES).map(([type, config]) => (
                <button
                  key={type}
                  onClick={() => addNode(type)}
                  className="flex flex-col items-center justify-center gap-2 p-3 border-2 border-slate-100 rounded-xl hover:border-indigo-500 hover:bg-indigo-50 transition-all group active:scale-95"
                >
                  <div 
                    className="w-10 h-10 rounded-lg flex items-center justify-center text-white shadow-md group-hover:scale-110 transition-transform"
                    style={{ backgroundColor: config.color }}
                  >
                    <span className="text-[10px] font-black">{config.label}</span>
                  </div>
                  <span className="text-sm font-semibold text-slate-700">{type}</span>
                </button>
              ))}
            </div>
          </section>

          <section className="mt-auto">
            <div className="bg-slate-900 rounded-xl p-4 text-white">
              <h4 className="text-sm font-bold mb-2 flex items-center gap-2">
                <Play size={14} className="text-green-400" fill="currentColor" /> Live Simulation
              </h4>
              <p className="text-xs text-slate-400 leading-relaxed">
                স্বয়ংক্রিয়ভাবে সার্কিটটি এখন লাইভ চলছে। ইনপুট পরিবর্তন করে ফলাফল দেখুন।
              </p>
            </div>
          </section>
        </aside>

        {/* Canvas Area */}
        <main 
          ref={canvasRef}
          className="flex-1 relative bg-[radial-gradient(#e2e8f0_1px,transparent_1px)] bg-[size:30px_30px] overflow-hidden"
          onMouseMove={handleMouseMove}
          onMouseUp={handleMouseUp}
          onMouseLeave={handleMouseUp}
        >
          {/* Instructions Overlay */}
          {nodes.length === 0 && (
            <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
              <div className="text-center">
                <div className="inline-flex p-6 bg-white rounded-full shadow-2xl mb-4 border border-slate-100 opacity-50">
                  <Plus size={48} className="text-slate-300" />
                </div>
                <h2 className="text-2xl font-bold text-slate-400">শুরু করতে বাম পাশের টুলস থেকে গেট যোগ করুন</h2>
              </div>
            </div>
          )}

          {/* Connections SVG Layer */}
          <svg className="absolute inset-0 w-full h-full pointer-events-none">
            {connections.map(conn => {
              const fromNode = nodes.find(n => n.id === conn.fromId);
              const toNode = nodes.find(n => n.id === conn.toId);
              if (!fromNode || !toNode) return null;
              
              const isActive = simulationResults[fromNode.id];
              const d = `M ${fromNode.x + 80} ${fromNode.y + 30} C ${fromNode.x + 130} ${fromNode.y + 30}, ${toNode.x - 50} ${toNode.y + 30}, ${toNode.x} ${toNode.y + 30}`;
              
              return (
                <path
                  key={conn.id}
                  d={d}
                  fill="none"
                  stroke={isActive ? '#3b82f6' : '#94a3b8'}
                  strokeWidth={isActive ? 4 : 2}
                  className="transition-all duration-300"
                  strokeLinecap="round"
                />
              );
            })}
            {activeWire && (
              <path
                d={`M ${activeWire.startX} ${activeWire.startY} C ${activeWire.startX + 50} ${activeWire.startY}, ${activeWire.endX - 50} ${activeWire.endY}, ${activeWire.endX} ${activeWire.endY}`}
                fill="none"
                stroke="#6366f1"
                strokeWidth="2"
                strokeDasharray="4"
              />
            )}
          </svg>

          {/* Nodes Layer */}
          {nodes.map(node => (
            <div
              key={node.id}
              style={{ left: node.x, top: node.y }}
              onMouseDown={(e) => handleMouseDown(e, node)}
              className={`absolute w-32 h-16 bg-white border-2 rounded-xl shadow-lg flex items-center justify-center cursor-move select-none transition-shadow group
                ${draggingNode === node.id ? 'shadow-2xl ring-2 ring-indigo-500 ring-opacity-50' : 'hover:shadow-xl'}
                ${simulationResults[node.id] ? 'border-indigo-400' : 'border-slate-200'}`}
            >
              {/* Input Port (Left) */}
              {GATE_TYPES[node.type].inputs > 0 && (
                <div 
                  data-port="input"
                  onMouseUp={(e) => endWire(e, node.id)}
                  className="absolute -left-2 w-4 h-4 bg-slate-300 rounded-full border-2 border-white hover:bg-indigo-500 transition-colors cursor-crosshair shadow-sm"
                />
              )}

              {/* Content */}
              <div className="flex flex-col items-center">
                <span className="text-[10px] uppercase font-bold text-slate-400 tracking-tighter leading-none mb-1">
                  {node.type}
                </span>
                
                {node.type === 'SWITCH' ? (
                  <button 
                    onClick={() => toggleSwitch(node.id)}
                    className={`px-3 py-1 rounded-full text-xs font-bold transition-all ${node.state ? 'bg-indigo-600 text-white shadow-inner' : 'bg-slate-100 text-slate-500'}`}
                  >
                    {node.state ? 'ON' : 'OFF'}
                  </button>
                ) : node.type === 'BULB' ? (
                  <div className={`w-6 h-6 rounded-full flex items-center justify-center shadow-lg transition-all duration-300 ${simulationResults[node.id] ? 'bg-yellow-400 animate-pulse ring-4 ring-yellow-100' : 'bg-slate-200 opacity-50'}`}>
                    <Zap size={14} className={simulationResults[node.id] ? 'text-white' : 'text-slate-400'} fill="currentColor" />
                  </div>
                ) : (
                  <span className="text-lg font-black text-slate-700">{GATE_TYPES[node.type].label}</span>
                )}
              </div>

              {/* Output Port (Right) */}
              <div 
                data-port="output"
                onMouseDown={(e) => startWire(e, node.id)}
                className={`absolute -right-2 w-4 h-4 rounded-full border-2 border-white hover:bg-indigo-500 transition-colors cursor-crosshair shadow-sm
                  ${simulationResults[node.id] ? 'bg-indigo-500' : 'bg-slate-400'}`}
              />

              {/* Delete Button */}
              <button 
                onClick={() => deleteNode(node.id)}
                className="absolute -top-2 -right-2 w-6 h-6 bg-white rounded-full flex items-center justify-center text-slate-300 hover:text-red-500 shadow-md border border-slate-100 opacity-0 group-hover:opacity-100 transition-all scale-75 group-hover:scale-100"
              >
                <Trash2 size={12} />
              </button>
            </div>
          ))}
        </main>
      </div>

      {/* Footer Info */}
      <footer className="h-10 bg-white border-t border-slate-200 px-6 flex items-center justify-between text-[11px] text-slate-500 font-medium">
        <div className="flex gap-4">
          <span>Nodes: {nodes.length}</span>
          <span>Connections: {connections.length}</span>
        </div>
        <div className="flex items-center gap-1">
          <div className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
          Simulation Engine Active
        </div>
      </footer>
    </div>
  );
};

export default App;
