<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logic Designer Pro - AI Powered</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: #f8fafc; }
        .canvas-grid {
            background-image: radial-gradient(#cbd5e1 1.5px, transparent 1.5px);
            background-size: 30px 30px;
        }
        .wire-active { stroke-dasharray: 8; animation: flow 1s linear infinite; stroke: #3b82f6; stroke-width: 4; }
        @keyframes flow { to { stroke-dashoffset: -16; } }
        .gate-node { transition: all 0.3s ease; cursor: grab; }
        .gate-node:active { cursor: grabbing; }
        .loading-shimmer {
            background: linear-gradient(90deg, #eff6ff 25%, #dbeafe 50%, #eff6ff 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, useCallback } = React;

        const GATE_CONFIGS = {
            AND: { color: '#3b82f6', d: "M 5 10 Q 25 10 35 25 Q 25 40 5 40 Z" },
            OR: { color: '#10b981', d: "M 5 10 Q 20 10 35 25 Q 20 40 5 40 Q 12 25 5 10 Z" },
            NOT: { color: '#ef4444', d: "M 5 10 L 30 25 L 5 40 Z" },
            SWITCH: { color: '#64748b', special: 'switch' },
            BULB: { color: '#eab308', special: 'bulb' }
        };

        const App = () => {
            const [nodes, setNodes] = useState([]);
            const [connections, setConnections] = useState([]);
            const [results, setResults] = useState({});
            const [equation, setEquation] = useState("A.B + C");
            const [isLoading, setIsLoading] = useState(false);
            const [errorMsg, setErrorMsg] = useState("");
            
            const [userApiKey, setUserApiKey] = useState(localStorage.getItem('gemini_api_key') || "");
            const [showKeyModal, setShowKeyModal] = useState(!localStorage.getItem('gemini_api_key'));

            const canvasRef = useRef(null);

            const saveApiKey = (key) => {
                const trimmedKey = key.trim();
                localStorage.setItem('gemini_api_key', trimmedKey);
                setUserApiKey(trimmedKey);
                setShowKeyModal(false);
                setErrorMsg("");
            };

            const runSimulation = useCallback(() => {
                const newResults = {};
                const processed = new Set();

                const evaluate = (nodeId) => {
                    if (processed.has(nodeId)) return newResults[nodeId];
                    const node = nodes.find(n => n.id === nodeId);
                    if (!node) return false;

                    if (node.type === 'SWITCH') {
                        newResults[nodeId] = !!node.state;
                    } else {
                        const incomingConnections = connections.filter(c => c.toId === nodeId);
                        const incomingValues = incomingConnections.map(c => evaluate(c.fromId));

                        let res = false;
                        switch (node.type) {
                            case 'AND': 
                                res = incomingValues.length >= 2 && incomingValues.every(v => v === true); 
                                break;
                            case 'OR': 
                                res = incomingValues.length > 0 && incomingValues.some(v => v === true); 
                                break;
                            case 'NOT': 
                                res = incomingValues.length > 0 ? !incomingValues[0] : false; 
                                break;
                            case 'BULB': 
                                res = incomingValues.length > 0 ? incomingValues[0] : false; 
                                break;
                        }
                        newResults[nodeId] = res;
                    }
                    processed.add(nodeId);
                    return newResults[nodeId];
                };

                nodes.forEach(n => evaluate(n.id));
                setResults(newResults);
            }, [nodes, connections]);

            useEffect(() => { runSimulation(); }, [nodes, connections, runSimulation]);

            const generateWithAI = async () => {
                if (!equation.trim()) return;
                if (!userApiKey) {
                    setShowKeyModal(true);
                    return;
                }
                
                setIsLoading(true);
                setErrorMsg("");

                const systemPrompt = `You are a Logic Circuit Designer. 
                Task: Convert boolean expressions into a JSON circuit map.
                Available nodes: 'SWITCH' (inputs), 'AND', 'OR', 'NOT', 'BULB' (final output).
                
                Rules:
                1. Each unique variable (A, B, C...) must be a separate SWITCH node.
                2. Use logical priority: NOT (!) first, then AND (.), then OR (+).
                3. Position nodes from left to right. SWITCH nodes at x=50, gates in middle (x=300-500), BULB at x=800.
                4. Output ONLY valid JSON with 'nodes' [id, type, label, x, y] and 'connections' [id, fromId, toId].
                5. Ensure the logic exactly matches the expression. Don't simplify unnecessarily.`;

                const userPrompt = `Create a realistic circuit diagram for the expression: ${equation}`;

                const fetchCircuit = async (retries = 0) => {
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userApiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: userPrompt }] }],
                                systemInstruction: { parts: [{ text: systemPrompt }] },
                                generationConfig: { 
                                    responseMimeType: "application/json",
                                    temperature: 0.2 // logic-er jonno low temperature bhalo
                                }
                            })
                        });

                        if (!response.ok) throw new Error("API Key ভুল অথবা কোটা শেষ হয়ে গেছে।");

                        const data = await response.json();
                        const rawJson = data.candidates?.[0]?.content?.parts?.[0]?.text;
                        const parsed = JSON.parse(rawJson);

                        if (parsed.nodes && parsed.connections) {
                            setNodes(parsed.nodes.map(n => ({ ...n, state: n.type === 'SWITCH' ? false : undefined })));
                            setConnections(parsed.connections);
                        } else {
                            throw new Error("AI সঠিক ডাটা ফরম্যাট পাঠাতে পারেনি।");
                        }
                    } catch (err) {
                        if (retries < 2) {
                            setTimeout(() => fetchCircuit(retries + 1), 1000);
                        } else {
                            setErrorMsg(err.message || "সার্কিট তৈরি করা সম্ভব হচ্ছে না।");
                        }
                    } finally {
                        setIsLoading(false);
                    }
                };

                fetchCircuit();
            };

            return (
                <div className="flex flex-col h-screen text-slate-800 font-sans relative">
                    {/* API Key Modal */}
                    {showKeyModal && (
                        <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
                            <div className="bg-white rounded-3xl p-8 max-w-md w-full shadow-2xl border border-slate-200">
                                <h2 className="text-2xl font-black mb-2">API Key সেট করুন</h2>
                                <p className="text-slate-500 text-sm mb-6">আপনার Gemini API Key টি এখানে দিন। এটি না দিলে ড্রয়িং ফিচার কাজ করবে না।</p>
                                <input 
                                    id="api-input"
                                    type="password"
                                    defaultValue={userApiKey}
                                    className="w-full px-4 py-3 bg-slate-100 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-500 mb-4 font-mono"
                                    placeholder="Paste your key here..."
                                />
                                <div className="flex gap-3">
                                    <button 
                                        onClick={() => saveApiKey(document.getElementById('api-input').value)}
                                        className="flex-1 bg-indigo-600 text-white font-bold py-3 rounded-xl hover:bg-indigo-700 transition-colors"
                                    >
                                        সেভ করুন
                                    </button>
                                    <a href="https://aistudio.google.com/app/apikey" target="_blank" className="px-4 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold flex items-center justify-center hover:bg-slate-200 transition-colors">
                                        কী (Key) নিন
                                    </a>
                                </div>
                            </div>
                        </div>
                    )}

                    <header className="h-20 bg-white border-b flex items-center justify-between px-8 shadow-sm z-20">
                        <div className="flex items-center gap-4 cursor-pointer" onClick={() => setShowKeyModal(true)}>
                            <div className="w-12 h-12 bg-indigo-600 rounded-2xl flex items-center justify-center text-white font-bold shadow-lg shadow-indigo-100">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
                            </div>
                            <div>
                                <h1 className="font-black text-xl tracking-tight uppercase">Logic Pro AI</h1>
                                <p className="text-[10px] text-indigo-500 font-bold uppercase tracking-[0.2em]">Smart Circuit Designer</p>
                            </div>
                        </div>

                        <div className="flex flex-1 max-w-2xl mx-12 gap-3 p-1.5 bg-slate-100 rounded-2xl border border-slate-200">
                            <input 
                                value={equation}
                                onChange={(e) => setEquation(e.target.value)}
                                className="flex-1 px-4 bg-transparent outline-none font-mono text-sm font-bold text-slate-700"
                                placeholder="উদাহরণ: (A . B) + !C"
                                onKeyDown={(e) => e.key === 'Enter' && generateWithAI()}
                            />
                            <button 
                                onClick={generateWithAI}
                                disabled={isLoading}
                                className={`px-8 py-2.5 rounded-xl font-bold text-sm transition-all shadow-md flex items-center gap-2 ${isLoading ? 'bg-slate-300 text-slate-500' : 'bg-indigo-600 text-white hover:bg-indigo-700 active:scale-95'}`}
                            >
                                {isLoading ? (
                                    <><div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div> তৈরি হচ্ছে...</>
                                ) : (
                                    'ড্র করো'
                                )}
                            </button>
                        </div>
                    </header>

                    <main className="flex-1 relative canvas-grid bg-white overflow-hidden" ref={canvasRef}>
                        {isLoading && <div className="absolute inset-0 z-30 loading-shimmer opacity-20 pointer-events-none"></div>}
                        
                        {errorMsg && (
                            <div className="absolute top-4 left-1/2 -translate-x-1/2 bg-red-50 text-red-600 px-6 py-3 rounded-2xl border border-red-200 shadow-xl font-bold text-sm z-40 animate-bounce">
                                ⚠️ {errorMsg}
                            </div>
                        )}

                        <svg className="absolute inset-0 w-full h-full pointer-events-none">
                            {connections.map(c => {
                                const fn = nodes.find(n => n.id === c.fromId);
                                const tn = nodes.find(n => n.id === c.toId);
                                if (!fn || !tn) return null;
                                const active = results[fn.id];
                                return (
                                    <path 
                                        key={c.id} 
                                        d={`M ${fn.x + 112} ${fn.y + 40} C ${fn.x + 180} ${fn.y + 40}, ${tn.x - 80} ${tn.y + 40}, ${tn.x} ${tn.y + 40}`} 
                                        fill="none" 
                                        stroke={active ? '#3b82f6' : '#cbd5e1'} 
                                        strokeWidth={active ? 4 : 2}
                                        className={active ? 'wire-active' : 'transition-all duration-300'}
                                    />
                                );
                            })}
                        </svg>

                        {nodes.map(node => (
                            <div 
                                key={node.id} 
                                style={{ left: node.x, top: node.y }}
                                className={`gate-node absolute w-28 h-20 bg-white border-2 rounded-2xl shadow-sm flex flex-col items-center justify-center group ${results[node.id] ? 'border-indigo-500 ring-4 ring-indigo-100 shadow-indigo-100' : 'border-slate-100'}`}
                            >
                                {node.type === 'SWITCH' ? (
                                    <div className="flex flex-col items-center gap-2">
                                        <button 
                                            onClick={() => setNodes(nodes.map(n => n.id === node.id ? {...n, state: !n.state} : n))}
                                            className={`w-10 h-5 rounded-full transition-all relative ${node.state ? 'bg-indigo-600' : 'bg-slate-200'}`}
                                        >
                                            <div className={`absolute top-0.5 w-4 h-4 bg-white rounded-full shadow transition-all ${node.state ? 'left-5.5' : 'left-0.5'}`}></div>
                                        </button>
                                        <span className="text-[11px] font-black text-indigo-900 bg-indigo-50 px-2 rounded">{node.label}</span>
                                    </div>
                                ) : node.type === 'BULB' ? (
                                    <div className="flex flex-col items-center gap-1">
                                        <div className={`w-8 h-8 rounded-full border-2 transition-all duration-300 ${results[node.id] ? 'bg-yellow-400 border-yellow-500 shadow-[0_0_20px_rgba(234,179,8,0.5)]' : 'bg-slate-50 border-slate-200'}`} />
                                        <span className="text-[8px] font-bold text-slate-400 uppercase">Output</span>
                                    </div>
                                ) : (
                                    <div className="flex flex-col items-center">
                                        <svg viewBox="0 0 50 50" className="h-8">
                                            <path d={GATE_CONFIGS[node.type].d} fill="none" stroke={GATE_CONFIGS[node.type].color} strokeWidth="3" />
                                        </svg>
                                        <span className="text-[9px] font-bold text-slate-400 mt-1">{node.type}</span>
                                    </div>
                                )}
                            </div>
                        ))}
                    </main>

                    <footer className="h-10 bg-slate-900 text-white flex items-center px-8 text-[10px] font-bold gap-6 uppercase tracking-wider">
                        <div className="flex gap-4">
                            <span className="text-indigo-400">● AI Engine Ready</span>
                            <span className="text-slate-700">|</span>
                            <span>(.) AND</span>
                            <span>(+) OR</span>
                            <span>(!) NOT</span>
                        </div>
                        <div className="ml-auto text-slate-500">Logic Designer AI v3.5</div>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
